# üí≥ MoMo Payment Integration Guide

## üìã T·ªïng quan

H·ªá th·ªëng Smart Dental Healthcare ƒë√£ t√≠ch h·ª£p thanh to√°n MoMo ƒë·ªÉ cho ph√©p b·ªánh nh√¢n thanh to√°n ph√≠ kh√°m tr·ª±c tuy·∫øn m·ªôt c√°ch ti·ªán l·ª£i v√† an to√†n.

### T√≠nh nƒÉng ch√≠nh:
- ‚úÖ T·∫°o payment link MoMo cho appointment
- ‚úÖ Redirect ƒë·∫øn MoMo app/web ƒë·ªÉ thanh to√°n
- ‚úÖ Nh·∫≠n callback (IPN) t·ª´ MoMo
- ‚úÖ Verify signature ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh b·∫£o m·∫≠t
- ‚úÖ Query payment status
- ‚úÖ Payment result page v·ªõi UI th√¢n thi·ªán
- ‚úÖ L∆∞u tr·ªØ payment history

---

## üèóÔ∏è Ki·∫øn tr√∫c

### Flow Diagram:

```
Patient                    Frontend                Backend                 MoMo
   ‚îÇ                          ‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îÇ 1. ƒê·∫∑t l·ªãch th√†nh c√¥ng   ‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îÇ 2. Click "Thanh to√°n MoMo"‚îÇ                      ‚îÇ                      ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îÇ                          ‚îÇ 3. POST /momo/create  ‚îÇ                      ‚îÇ
   ‚îÇ                          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                      ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ 4. Create payment    ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ 5. Return payUrl     ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ                          ‚îÇ 6. Return payUrl      ‚îÇ                      ‚îÇ
   ‚îÇ                          ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                      ‚îÇ
   ‚îÇ 7. Redirect to payUrl    ‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ                      ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îÇ 8. Pay on MoMo           ‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ 9. IPN callback      ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ                          ‚îÇ                       ‚îÇ 10. Update payment   ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îÇ 11. Return 200 OK    ‚îÇ
   ‚îÇ                          ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ 12. Redirect to result   ‚îÇ                       ‚îÇ                      ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ                          ‚îÇ                       ‚îÇ                      ‚îÇ
```

---

## üîß Backend Implementation

### 1. MoMo Service

**File**: `server/src/modules/payments/services/momo.service.ts`

#### C√°c method ch√≠nh:

```typescript
class MoMoService {
  // T·∫°o payment request
  async createPayment(request: MoMoPaymentRequest): Promise<MoMoPaymentResponse>
  
  // Verify callback signature
  verifyCallbackSignature(callbackData: MoMoCallbackData): boolean
  
  // Query transaction status
  async queryTransaction(orderId: string, requestId: string): Promise<any>
}
```

#### Signature Generation:

```typescript
const rawSignature = 
  `accessKey=${accessKey}` +
  `&amount=${amount}` +
  `&extraData=${extraData}` +
  `&ipnUrl=${ipnUrl}` +
  `&orderId=${orderId}` +
  `&orderInfo=${orderInfo}` +
  `&partnerCode=${partnerCode}` +
  `&redirectUrl=${redirectUrl}` +
  `&requestId=${requestId}` +
  `&requestType=captureWallet`;

const signature = crypto
  .createHmac('sha256', secretKey)
  .update(rawSignature)
  .digest('hex');
```

### 2. Payment Service

**File**: `server/src/modules/payments/payments.service.ts`

#### Create MoMo Payment:

```typescript
async createMomoPayment(payload: {
  appointmentId: string;
  patientId: string;
  doctorId: string;
  amount: number;
  orderInfo: string;
}) {
  // 1. Generate unique orderId
  const orderId = `APT_${appointmentId}_${Date.now()}`;
  
  // 2. Save payment record (status = pending)
  const payment = await this.paymentModel.create({...});
  
  // 3. Create MoMo payment request
  const momoResponse = await this.momoService.createPayment({
    orderId,
    amount,
    orderInfo,
    returnUrl: `${frontendUrl}/patient/appointments/payment-result`,
    notifyUrl: `${backendUrl}/api/v1/payments/momo/callback`,
    extraData: JSON.stringify({ paymentId, appointmentId })
  });
  
  // 4. Return payUrl to frontend
  return { payUrl: momoResponse.payUrl };
}
```

#### Handle Callback (IPN):

```typescript
async handleMomoCallback(callbackData: MoMoCallbackData) {
  // 1. Verify signature
  const isValid = this.momoService.verifyCallbackSignature(callbackData);
  if (!isValid) throw new Error('Invalid signature');
  
  // 2. Parse extraData
  const { paymentId, appointmentId } = JSON.parse(callbackData.extraData);
  
  // 3. Update payment status
  const status = callbackData.resultCode === 0 ? 'completed' : 'failed';
  await this.paymentModel.findByIdAndUpdate(paymentId, {
    status,
    paymentDate: new Date(),
    transactionId: callbackData.transId,
  });
  
  // 4. Send notification (TODO)
  // 5. Update appointment status (TODO)
}
```

### 3. API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/payments/momo/create` | T·∫°o payment link |
| POST | `/api/v1/payments/momo/callback` | IPN callback t·ª´ MoMo |
| GET | `/api/v1/payments/momo/query/:orderId` | Query payment status |
| GET | `/api/v1/payments/:id` | Get payment by ID |
| GET | `/api/v1/payments/patient/:patientId` | Get payments by patient |

---

## üíª Frontend Implementation

### 1. Payment Service

**File**: `client/src/services/paymentService.ts`

```typescript
const paymentService = {
  // T·∫°o MoMo payment
  async createMoMoPayment(request: CreateMoMoPaymentRequest, accessToken?: string): Promise<MoMoPaymentResponse>
  
  // Query payment status
  async queryMoMoPayment(orderId: string, accessToken?: string): Promise<any>
  
  // Get payment by ID
  async getPaymentById(paymentId: string, accessToken?: string): Promise<any>
  
  // Get payments by patient
  async getPaymentsByPatient(patientId: string, accessToken?: string): Promise<any>
}
```

### 2. MoMo Payment Button

**File**: `client/src/components/appointments/MoMoPaymentButton.tsx`

```tsx
<MoMoPaymentButton
  appointmentId={appointmentId}
  patientId={patientId}
  doctorId={doctorId}
  amount={50000}
  orderInfo="Thanh to√°n l·ªãch kh√°m"
  accessToken={session?.access_token}
  onSuccess={() => console.log('Payment initiated')}
  onError={(error) => console.error(error)}
/>
```

### 3. Payment Result Page

**File**: `client/src/app/patient/appointments/payment-result/page.tsx`

- Parse URL parameters t·ª´ MoMo redirect
- Query payment status t·ª´ backend
- Hi·ªÉn th·ªã k·∫øt qu·∫£ thanh to√°n (success/failed)
- Actions: Xem l·ªãch h·∫πn, Xem l·ªãch s·ª≠ thanh to√°n, Th·ª≠ l·∫°i

### 4. Integration v√†o Appointment Confirmation

**File**: `client/src/components/appointments/AppointmentConfirmation.tsx`

```tsx
<AppointmentConfirmationComponent
  confirmation={confirmation}
  onClose={handleClose}
  // Payment options
  enablePayment={true}
  paymentAmount={50000}
  patientId={session?.user?._id}
  accessToken={session?.access_token}
/>
```

---

## üîê Security

### 1. Signature Verification

**Backend** verify m·ªçi callback t·ª´ MoMo:

```typescript
verifyCallbackSignature(callbackData) {
  const rawSignature = 
    `accessKey=${accessKey}` +
    `&amount=${amount}` +
    `&extraData=${extraData}` +
    `&message=${message}` +
    `&orderId=${orderId}` +
    // ... other fields
    
  const expectedSignature = crypto
    .createHmac('sha256', secretKey)
    .update(rawSignature)
    .digest('hex');
    
  return expectedSignature === callbackData.signature;
}
```

### 2. HTTPS Only

- Production endpoint: `https://payment.momo.vn`
- Test endpoint: `https://test-payment.momo.vn`

### 3. IPN (Instant Payment Notification)

- Backend nh·∫≠n callback t·ª´ MoMo **tr∆∞·ªõc khi** user ƒë∆∞·ª£c redirect
- ƒê·∫£m b·∫£o payment status ƒë∆∞·ª£c c·∫≠p nh·∫≠t k·ªÉ c·∫£ khi user ƒë√≥ng browser

---

## ‚öôÔ∏è Configuration

### Backend Environment Variables

```env
# MoMo Payment Gateway
MOMO_PARTNER_CODE=MOMO
MOMO_ACCESS_KEY=F8BBA842ECF85
MOMO_SECRET_KEY=K951B6PE1waDMi640xX08PD3vg6EkVlz
MOMO_ENDPOINT=https://test-payment.momo.vn

# URLs
BACKEND_URL=http://localhost:8081
FRONTEND_URL=http://localhost:3000
```

### Test Credentials

**‚ö†Ô∏è Ch·ªâ d√πng cho development/testing:**

- **Partner Code**: `MOMO`
- **Access Key**: `F8BBA842ECF85`
- **Secret Key**: `K951B6PE1waDMi640xX08PD3vg6EkVlz`

### Production Credentials

ƒê·ªÉ l·∫•y production credentials, li√™n h·ªá MoMo t·∫°i: https://business.momo.vn/

---

## üß™ Testing

### 1. Test Flow (Development)

```bash
# 1. Start backend
cd server
npm run dev

# 2. Start frontend
cd client
npm run dev

# 3. Test steps:
# - Login as patient
# - Create appointment
# - Click "Thanh to√°n v·ªõi MoMo"
# - Should redirect to MoMo test page
# - Use test payment info from MoMo docs
# - Complete payment
# - Should redirect back to payment-result page
```

### 2. Test Credentials (MoMo Test Environment)

Theo t√†i li·ªáu MoMo, test environment c√≥ th·ªÉ:
- T·∫°o payment link th√†nh c√¥ng
- Simulate payment success/failure
- Nh·∫≠n callback

### 3. Manual Testing Checklist

- [ ] T·∫°o payment link th√†nh c√¥ng
- [ ] payUrl ƒë∆∞·ª£c tr·∫£ v·ªÅ
- [ ] Redirect ƒë·∫øn MoMo test page
- [ ] Callback ƒë∆∞·ª£c nh·∫≠n v√† x·ª≠ l√Ω ƒë√∫ng
- [ ] Payment status ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong DB
- [ ] Redirect v·ªÅ payment-result page
- [ ] Payment result hi·ªÉn th·ªã ƒë√∫ng th√¥ng tin
- [ ] Payment history ƒë∆∞·ª£c l∆∞u

---

## üöÄ Deployment

### 1. Update Environment Variables

```bash
# Production .env
MOMO_PARTNER_CODE=<your-partner-code>
MOMO_ACCESS_KEY=<your-access-key>
MOMO_SECRET_KEY=<your-secret-key>
MOMO_ENDPOINT=https://payment.momo.vn

BACKEND_URL=https://api.yourdomain.com
FRONTEND_URL=https://yourdomain.com
```

### 2. Whitelist IPN URL

ƒê·∫£m b·∫£o MoMo c√≥ th·ªÉ g·ªçi ƒë·∫øn IPN URL c·ªßa b·∫°n:
- URL: `https://api.yourdomain.com/api/v1/payments/momo/callback`
- Method: POST
- Must be HTTPS
- Must return 200 OK

### 3. SSL Certificate

ƒê·∫£m b·∫£o domain c√≥ SSL certificate h·ª£p l·ªá.

---

## üìä Database Schema

### Payment Collection

```typescript
{
  _id: ObjectId,
  patientId: ObjectId,
  doctorId: ObjectId,
  amount: Number,
  status: 'pending' | 'completed' | 'failed' | 'refunded',
  type: 'appointment',
  refId: ObjectId,  // appointmentId
  refModel: 'Appointment',
  paymentDate: Date,
  paymentMethod: 'momo',
  transactionId: String,  // orderId or MoMo transId
  notes: String,
  createdAt: Date,
  updatedAt: Date
}
```

---

## üêõ Troubleshooting

### 1. Payment creation fails

**Ki·ªÉm tra:**
- MOMO credentials ƒë√∫ng ch∆∞a
- MOMO_ENDPOINT ƒë√∫ng (test vs production)
- Network connectivity
- Console logs trong MoMoService

### 2. Callback kh√¥ng ƒë∆∞·ª£c nh·∫≠n

**Ki·ªÉm tra:**
- IPN URL accessible t·ª´ internet
- Firewall rules
- HTTPS certificate h·ª£p l·ªá
- Console logs trong payments.controller.ts

### 3. Invalid signature error

**Ki·ªÉm tra:**
- Secret key ƒë√∫ng
- Raw signature string format ƒë√∫ng
- Field order trong raw signature

### 4. Payment status kh√¥ng c·∫≠p nh·∫≠t

**Ki·ªÉm tra:**
- Callback handler c√≥ ch·∫°y kh√¥ng
- Database connection
- Payment ID trong extraData

---

## üìö References

- [MoMo Developer Documentation](https://developers.momo.vn/#/docs/en/aiov2/?id=payment-method)
- [MoMo Business Portal](https://business.momo.vn/)

---

## üéâ Features Roadmap

### Completed ‚úÖ
- [x] MoMo payment integration
- [x] Payment service backend
- [x] Payment button component
- [x] Payment result page
- [x] IPN callback handler
- [x] Signature verification

### Todo üìã
- [ ] Send notification khi payment success
- [ ] Auto update appointment status khi paid
- [ ] Payment history page cho patient
- [ ] Payment management cho admin
- [ ] Refund functionality
- [ ] Payment receipt PDF
- [ ] Email notification v·ªõi payment link
- [ ] SMS notification
- [ ] QR code payment option

---

**Created**: October 16, 2025  
**Status**: ‚úÖ Complete  
**Version**: 1.0.0


