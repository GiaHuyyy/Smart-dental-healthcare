# üí∞ LU·ªíNG THANH TO√ÅN ‚Üí DOANH THU B√ÅC Sƒ®

## üìã T·ªîNG QUAN LU·ªíNG

```
B·ªÜNH NH√ÇN                    BACKEND                    B√ÅC Sƒ®
   |                            |                         |
   |--1. ƒê·∫∑t l·ªãch------------>  |                         |
   |                            |                         |
   |<--2. T·∫°o appointment----   |                         |
   |    (pending_payment)       |                         |
   |                            |                         |
   |--3. T·∫°o payment-------->   |                         |
   |                            |                         |
   |<--4. MoMo payment URL--    |                         |
   |                            |                         |
   |--5. Thanh to√°n MoMo--->    |                         |
   |                            |                         |
   |                       MoMo |                         |
   |                            |                         |
   |                            |<--6. Callback MoMo---   |
   |                            |                         |
   |                            |--7. Update payment-->   |
   |                            |    (completed)          |
   |                            |                         |
   |                            |--8. Create revenue-->   |
   |                            |                         |
   |                            |--9. Send notification-->|
   |                            |                         |
   |                            |--10. Emit socket------->|--Revenue realtime
   |                            |        (revenue:new)    |
   |<--11. Payment result---    |                         |
   |    (redirect)              |                         |
   |                            |                         |
```

---

## üîÑ CHI TI·∫æT T·ª™NG B∆Ø·ªöC

### **1. B·ªánh nh√¢n ƒë·∫∑t l·ªãch** 
üìç `/patient/appointments`

**Frontend:**
```typescript
// T·∫°o appointment v·ªõi status: pending_payment
const appointmentResponse = await appointmentService.create({
  doctorId,
  patientId,
  appointmentDate,
  startTime,
  consultType,
  status: "pending_payment",  // ‚ö†Ô∏è CH√ö √ù: pending_payment
  paymentStatus: "unpaid",
  consultationFee
});
```

**Backend:**
```typescript
// AppointmentsController.create()
POST /api/v1/appointments
```

---

### **2. T·∫°o payment & redirect MoMo**
üìç `/patient/appointments`

**Frontend:**
```typescript
// T·∫°o MoMo payment URL
const paymentResponse = await paymentService.createMoMoPayment({
  appointmentId: appointment._id,
  patientId: session.user._id,
  doctorId: selectedDoctor._id,
  amount: consultationFee,
  orderInfo: `Thanh to√°n l·ªãch kh√°m #${appointment._id}`
});

// Redirect sang MoMo app/website
window.location.href = paymentResponse.data.payUrl;
```

**Backend:**
```typescript
// PaymentsController.createMomoPayment()
POST /api/v1/payments/momo

// T·∫°o payment record v·ªõi status: pending
const payment = await this.paymentModel.create({
  patientId,
  doctorId,
  amount,
  status: 'pending',  // ‚ö†Ô∏è CH√ö √ù: pending
  type: 'appointment',
  refId: appointmentId,
  refModel: 'Appointment',
  paymentMethod: 'momo',
  transactionId: orderId
});

// G·ªçi MoMo API
const momoResponse = await this.momoService.createPayment({
  orderId,
  amount,
  returnUrl: 'http://localhost:3000/patient/appointments/payment-result',
  notifyUrl: 'http://localhost:8081/api/v1/payments/momo/callback'
});
```

---

### **3. B·ªánh nh√¢n thanh to√°n tr√™n MoMo**
üìç MoMo App/Website

- B·ªánh nh√¢n nh·∫≠p th√¥ng tin thanh to√°n
- MoMo x·ª≠ l√Ω giao d·ªãch
- MoMo g·ª≠i callback v·ªÅ backend

---

### **4. MoMo g·ª≠i callback v·ªÅ Backend**
üìç Backend receives callback

**Backend:**
```typescript
// PaymentsController.handleMomoCallback()
POST /api/v1/payments/momo/callback

async handleMomoCallback(callbackData: MoMoCallbackData) {
  // 1. Verify signature
  const isValid = this.momoService.verifyCallbackSignature(callbackData);
  
  // 2. Update payment status
  const status = callbackData.resultCode === 0 ? 'completed' : 'failed';
  
  await this.paymentModel.findByIdAndUpdate(paymentId, {
    status,  // ‚ö†Ô∏è CH√ö √ù: completed
    paymentDate: new Date(),
    transactionId: callbackData.transId
  });
  
  // 3. üí∞ T·∫†O REVENUE (QUAN TR·ªåNG!)
  if (status === 'completed') {
    const revenueResult = await this.revenueService.createRevenueFromPayment(paymentId);
    
    // 4. üîî G·ª¨I TH√îNG B√ÅO CHO B√ÅC Sƒ®
    if (revenueResult.success) {
      await this.notificationGateway.sendNotificationToUser(
        doctorId,
        {
          title: 'üí∞ Doanh thu m·ªõi',
          message: `B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ${formattedAmount} t·ª´ thanh to√°n c·ªßa ${patientName}`,
          type: 'revenue',
          linkTo: '/doctor/revenue'
        }
      );
    }
  }
  
  // 5. Update appointment status
  if (status === 'completed') {
    await this.appointmentModel.findByIdAndUpdate(appointmentId, {
      status: 'confirmed',  // ‚ö†Ô∏è CH√ö √ù: confirmed
      paymentStatus: 'paid',
      paymentId
    });
  }
}
```

---

### **5. T·∫°o Revenue t·ª´ Payment**
üìç `RevenueService.createRevenueFromPayment()`

**Backend:**
```typescript
async createRevenueFromPayment(paymentId: string) {
  // 1. L·∫•y payment info
  const payment = await this.paymentModel
    .findById(paymentId)
    .populate('doctorId')
    .populate('patientId')
    .exec();
  
  // 2. T√≠nh ph√≠ n·ªÅn t·∫£ng (5%)
  const platformFeeRate = 0.05;
  const platformFee = Math.round(payment.amount * platformFeeRate);
  const netAmount = payment.amount - platformFee;
  
  // 3. T·∫°o revenue record
  const revenue = await this.revenueModel.create({
    doctorId: payment.doctorId,
    paymentId: payment._id,
    patientId: payment.patientId,
    amount: payment.amount,          // T·ªïng ti·ªÅn
    platformFee,                     // Ph√≠ 5%
    netAmount,                       // Ti·ªÅn th·ª±c nh·∫≠n
    revenueDate: payment.paymentDate || new Date(),
    status: 'completed',
    refId: payment.refId,
    refModel: payment.refModel,
    type: payment.type
  });
  
  // 4. üîî EMIT SOCKET EVENT (REALTIME)
  const populatedRevenue = await this.revenueModel
    .findById(revenue._id)
    .populate('patientId', 'fullName email phone')
    .populate('paymentId', 'transactionId paymentMethod')
    .exec();
  
  this.revenueGateway.emitNewRevenue(doctorId, populatedRevenue);
  
  return { success: true, data: populatedRevenue };
}
```

**Log trong console:**
```
üí∞ Creating revenue for completed payment...
‚úÖ Revenue created successfully: { revenueId: xxx, doctorId: yyy, amount: 500000, netAmount: 475000 }
üîî Emitted realtime revenue update to doctor: yyy
```

---

### **6. G·ª≠i th√¥ng b√°o cho b√°c sƒ©**
üìç `NotificationGateway.sendNotificationToUser()`

**Backend:**
```typescript
// 1. L∆∞u v√†o database
const notification = await this.notificationModel.create({
  userId: doctorId,
  title: 'üí∞ Doanh thu m·ªõi',
  message: `B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c 500.000 ‚Ç´ t·ª´ thanh to√°n c·ªßa Nguy·ªÖn VƒÉn A`,
  type: 'revenue',
  data: {
    revenueId,
    paymentId,
    appointmentId,
    amount: 500000,
    netAmount: 475000,
    platformFee: 25000
  },
  linkTo: '/doctor/revenue',
  icon: 'wallet',
  isRead: false
});

// 2. Emit socket event (realtime)
this.server.to(`user_${doctorId}`).emit('notification:new', notification);
```

**Log trong console:**
```
‚úÖ Notification sent to doctor: xxx
Sent notification to user xxx: revenue
```

---

### **7. B√°c sƒ© nh·∫≠n th√¥ng b√°o realtime**
üìç `/doctor/revenue` & Notification Component

**Frontend - Notification Socket:**
```typescript
// NotificationButton.tsx ho·∫∑c NotificationsContent.tsx
useEffect(() => {
  if (!socket) return;
  
  socket.on('notification:new', (notification) => {
    console.log('üîî New notification:', notification);
    
    // Update notification list
    setNotifications(prev => [notification, ...prev]);
    
    // Update unread count
    setUnreadCount(prev => prev + 1);
    
    // Show toast (optional)
    toast.info(notification.title, {
      description: notification.message
    });
  });
}, [socket]);
```

**Frontend - Revenue Socket:**
```typescript
// useRevenueSocket.ts
useEffect(() => {
  if (!revenueSocket.isConnected) return;
  
  revenueSocket.onNewRevenue((data) => {
    console.log('üí∞ New revenue received:', data);
    
    // Reload revenue data
    loadRevenueData();
    
    // Show console log
    const amount = new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(data.revenue?.amount || 0);
    console.log(`üéâ Doanh thu m·ªõi: ${amount}`);
  });
}, [revenueSocket.isConnected]);
```

---

### **8. B·ªánh nh√¢n ƒë∆∞·ª£c redirect v·ªÅ k·∫øt qu·∫£**
üìç `/patient/appointments/payment-result?orderId=xxx&resultCode=0`

**Frontend:**
```typescript
// payment-result/page.tsx
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get('orderId');
  const resultCode = params.get('resultCode');
  
  // resultCode = 0: Success
  if (resultCode === '0') {
    setPaymentStatus('success');
    toast.success('Thanh to√°n th√†nh c√¥ng!');
  } else {
    setPaymentStatus('failed');
    toast.error('Thanh to√°n th·∫•t b·∫°i');
  }
  
  // Query backend ƒë·ªÉ l·∫•y payment info m·ªõi nh·∫•t
  const result = await paymentService.queryMoMoPayment(orderId);
  setPaymentInfo(result.data);
}, []);
```

---

## üéØ QUAN H·ªÜ GI·ªÆA C√ÅC B·∫¢NG

### **Payment ‚Üí Revenue**
```typescript
Payment {
  _id: '67xxx',
  patientId: 'patient_123',
  doctorId: 'doctor_456',
  amount: 500000,
  status: 'completed',
  paymentDate: '2025-10-24T10:30:00Z',
  type: 'appointment',
  refId: 'appointment_789'
}

‚Üì createRevenueFromPayment()

Revenue {
  _id: '68xxx',
  doctorId: 'doctor_456',
  paymentId: '67xxx',  // ‚Üê Link ƒë·∫øn Payment
  patientId: 'patient_123',
  amount: 500000,      // T·ªïng ti·ªÅn
  platformFee: 25000,  // 5% ph√≠
  netAmount: 475000,   // Ti·ªÅn th·ª±c nh·∫≠n (95%)
  revenueDate: '2025-10-24T10:30:00Z',
  status: 'completed',
  type: 'appointment',
  refId: 'appointment_789'
}
```

### **Revenue ‚Üí Notification**
```typescript
Revenue Created
   ‚Üì
Notification {
  _id: '69xxx',
  userId: 'doctor_456',  // B√°c sƒ© nh·∫≠n th√¥ng b√°o
  title: 'üí∞ Doanh thu m·ªõi',
  message: 'B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c 500.000 ‚Ç´ t·ª´ thanh to√°n c·ªßa Nguy·ªÖn VƒÉn A',
  type: 'revenue',
  data: {
    revenueId: '68xxx',
    paymentId: '67xxx',
    appointmentId: 'appointment_789',
    amount: 500000,
    netAmount: 475000
  },
  linkTo: '/doctor/revenue',
  isRead: false
}
```

---

## üîå SOCKET CONNECTIONS

### **1. Notification Socket** (namespace: `/notifications`)
```typescript
// Backend: NotificationGateway
@WebSocketGateway({ namespace: '/notifications' })

// Client connect with userId
socket = io('http://localhost:8081/notifications', {
  auth: { userId: session.user._id }
});

// Events:
- notification:new ‚Üí Th√¥ng b√°o m·ªõi
- notification:read ‚Üí ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
- notification:allRead ‚Üí ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
```

### **2. Revenue Socket** (namespace: `/revenue`)
```typescript
// Backend: RevenueGateway
@WebSocketGateway({ namespace: '/revenue' })

// Client connect with doctorId
socket = io('http://localhost:8081/revenue', {
  auth: { doctorId: session.user._id }
});

// Events:
- revenue:new ‚Üí Doanh thu m·ªõi
- revenue:updated ‚Üí Doanh thu c·∫≠p nh·∫≠t
- revenue:summaryUpdated ‚Üí T·ªïng quan c·∫≠p nh·∫≠t
```

---

## üìä D·ªÆ LI·ªÜU HI·ªÇN TH·ªä ·ªû B√ÅC Sƒ®

### **Trang Revenue (`/doctor/revenue`)**

**Summary Cards:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ T·ªïng doanh thu      ‚îÇ Ph√≠ n·ªÅn t·∫£ng        ‚îÇ Th·ª±c nh·∫≠n           ‚îÇ TƒÉng tr∆∞·ªüng         ‚îÇ
‚îÇ 500.000 ‚Ç´          ‚îÇ -25.000 ‚Ç´          ‚îÇ 475.000 ‚Ç´          ‚îÇ +10%                ‚îÇ
‚îÇ 1 giao d·ªãch        ‚îÇ 5% m·ªói giao d·ªãch   ‚îÇ Sau khi tr·ª´ ph√≠    ‚îÇ So v·ªõi th√°ng tr∆∞·ªõc  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Revenue List:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ng√†y       ‚îÇ B·ªánh nh√¢n    ‚îÇ Lo·∫°i    ‚îÇ T·ªïng ti·ªÅn ‚îÇ Ph√≠     ‚îÇ Th·ª±c nh·∫≠n ‚îÇ Tr·∫°ng th√°i ‚îÇ Giao d·ªãch    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 24/10/2025 ‚îÇ Nguy·ªÖn VƒÉn A ‚îÇ L·ªãch kh√°m‚îÇ 500.000 ‚Ç´‚îÇ 25.000 ‚Ç´‚îÇ 475.000 ‚Ç´‚îÇ Ho√†n th√†nh ‚îÇ APT_xxx_xxx  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Charts:**
- Bi·ªÉu ƒë·ªì xu h∆∞·ªõng theo th√°ng
- Bi·ªÉu ƒë·ªì ph√¢n lo·∫°i theo lo·∫°i d·ªãch v·ª•

### **Notification Bell**
```
üîî (1)  ‚Üê Badge hi·ªÉn th·ªã s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc

Click v√†o bell:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Th√¥ng b√°o                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üí∞ Doanh thu m·ªõi                     10:30  ‚îÇ
‚îÇ B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c 500.000 ‚Ç´ t·ª´...           ‚îÇ
‚îÇ [Xem chi ti·∫øt ‚Üí]                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìÖ L·ªãch h·∫πn m·ªõi                      09:15  ‚îÇ
‚îÇ Nguy·ªÖn VƒÉn A ƒë√£ ƒë·∫∑t l·ªãch kh√°m...           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚è±Ô∏è TH·ªúI GIAN REALTIME

```
Payment Completed (MoMo callback)
   ‚Üì < 100ms
Revenue Created
   ‚Üì < 100ms
Socket Event Emitted
   ‚Üì < 200ms
Frontend Receives Event
   ‚Üì < 100ms
UI Updates
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
T·ªîNG: < 500ms (< 0.5 gi√¢y)
```

---

## üß™ C√ÅCH TEST ƒê·∫¶Y ƒê·ª¶

### **Setup:**
1. Start Backend: `cd server && npm run start:dev`
2. Start Frontend: `cd client && npm run dev`
3. M·ªü 2 tr√¨nh duy·ªát/tab

### **Test Flow:**

**Tab 1 - B√°c sƒ©:**
```
1. Login v·ªõi t√†i kho·∫£n b√°c sƒ©
2. M·ªü /doctor/revenue
3. M·ªü Console (F12)
4. Check logs:
   ‚úÖ Connected to revenue socket
   ‚úÖ Subscribing to revenue updates
5. Gi·ªØ trang n√†y m·ªü
```

**Tab 2 - B·ªánh nh√¢n:**
```
1. Login v·ªõi t√†i kho·∫£n b·ªánh nh√¢n
2. M·ªü /patient/appointments
3. ƒê·∫∑t l·ªãch v·ªõi b√°c sƒ© ·ªü Tab 1
4. Ch·ªçn thanh to√°n MoMo
5. Thanh to√°n th√†nh c√¥ng
6. Redirect v·ªÅ /patient/appointments/payment-result
```

**Quan s√°t Tab 1 - B√°c sƒ©:**
```
Console logs:
üí∞ New revenue received: {...}
üéâ Doanh thu m·ªõi: 500.000 ‚Ç´

UI changes:
‚úÖ T·ªïng doanh thu: 500.000 ‚Ç´ (c·∫≠p nh·∫≠t)
‚úÖ Th·ª±c nh·∫≠n: 475.000 ‚Ç´ (c·∫≠p nh·∫≠t)
‚úÖ Danh s√°ch c√≥ record m·ªõi
‚úÖ Bi·ªÉu ƒë·ªì c·∫≠p nh·∫≠t
‚úÖ Notification bell c√≥ badge (1)
```

**Click Notification Bell:**
```
‚úÖ Th√¥ng b√°o "üí∞ Doanh thu m·ªõi" hi·ªÉn th·ªã
‚úÖ Click "Xem chi ti·∫øt" ‚Üí Navigate to /doctor/revenue
```

---

## üêõ TROUBLESHOOTING

### **Revenue kh√¥ng t·ª± ƒë·ªông c·∫≠p nh·∫≠t:**

**Check 1: Socket Connection**
```typescript
// Console should show:
üîå Connecting to revenue socket... doctor_xxx
‚úÖ Connected to revenue socket
üì° Subscribing to revenue updates...
```
‚Üí N·∫øu kh√¥ng th·∫•y: Ki·ªÉm tra `useRevenueSocket` hook

**Check 2: Backend Logs**
```
üîî ========== MOMO CALLBACK RECEIVED ==========
üí∞ Creating revenue for completed payment...
‚úÖ Revenue created successfully
üîî Emitted realtime revenue update to doctor: xxx
```
‚Üí N·∫øu kh√¥ng th·∫•y: Ki·ªÉm tra MoMo callback URL

**Check 3: Payment Status**
```typescript
// Database check
db.payments.findOne({ transactionId: 'APT_xxx' })
// Should show: status: 'completed'
```
‚Üí N·∫øu v·∫´n pending: MoMo callback ch∆∞a ch·∫°y

**Check 4: Revenue Creation**
```typescript
// Database check
db.revenues.find({ doctorId: 'doctor_xxx' }).sort({ createdAt: -1 })
// Should show revenue record m·ªõi
```
‚Üí N·∫øu kh√¥ng c√≥: Check logs createRevenueFromPayment

### **Th√¥ng b√°o kh√¥ng hi·ªÉn th·ªã:**

**Check 1: Notification Socket**
```typescript
// Check user connected
Backend log: "User xxx connected to notifications"
```

**Check 2: Notification Created**
```typescript
// Database check
db.notifications.find({ userId: 'doctor_xxx' }).sort({ createdAt: -1 })
```

**Check 3: Frontend Listening**
```typescript
// Check NotificationButton/NotificationsContent
socket.on('notification:new', callback) registered
```

---

## ‚úÖ SUCCESS INDICATORS

Khi m·ªçi th·ª© ho·∫°t ƒë·ªông ƒë√∫ng:

1. ‚úÖ Payment status = 'completed'
2. ‚úÖ Appointment status = 'confirmed'
3. ‚úÖ Revenue record ƒë∆∞·ª£c t·∫°o
4. ‚úÖ Notification ƒë∆∞·ª£c t·∫°o v√† emit
5. ‚úÖ Frontend console shows "üí∞ New revenue received"
6. ‚úÖ Revenue page t·ª± ƒë·ªông reload
7. ‚úÖ Notification bell c√≥ badge m·ªõi
8. ‚úÖ Click notification navigate ƒë√∫ng trang

---

**T·∫•t c·∫£ ƒë√£ s·∫µn s√†ng! H√£y test theo h∆∞·ªõng d·∫´n tr√™n ƒë·ªÉ x√°c nh·∫≠n.**
